<html>
    <head></head>
    <link rel="stylesheet" href="../styles/styles.css" />
    <body>
        <div class="inputContainer">
            <div class="container">
                <select type="text" class="inline-input" name="floorList"></select>
                <button type="button" class="button-menu" name="changeFloor">change floor</button>
                <button type="button" class="button-menu" name="getRouteOn">getRouteOn</button>
                <button type="button" class="button-menu" name="start">start</button>
                <button type="button" class="button-menu" name="stop">stop</button>
                <button type="button" class="button-menu" name="clear">clear</button>
            </div>
            <div class="container2">
                <select type="text" class="inline-input" name="removeBuildingList"></select>
                <button type="button" class="button-menu" name="removeBuilding">remove building</button>
            </div>
            <div class="container3">
                <select type="text" class="inline-input" name="addBuildingList"></select>
                <button type="button" class="button-menu" name="addBuilding">add building</button>
            </div>
        </div>
        <div id="map" class="map"></div>
    </body>
    <script type="text/javascript" src="https://api-assets.dabeeomaps.com/upload/library/dabeeomaps-4.0-latest.js"></script>
    <script>
        let mapData = null;
        let map = null;

        // addBuilding 의 대상이 되는 building id
        let selectedAddBuildingId = null;
        // removeBuilding 의 대상이 되는 building id
        let selectedRemoveBuildingId = null;
        // changeFloor 의 대상이 되는 floor id
        let selectedFloorId = null;

        async function init() {
            const dabeeoMaps = new dabeeo.Maps();

            // mapDataOption 정의 (통합지도)
            const mapDataOption = {
                clientId: '765KKomdQ3S9f-3GS1lEuX',
                clientSecret: 'ee5ac1e73bef9364949714965de7fe84',
                serverType: 'SERVER_STUDIO4', // studio4 지도를 사용하기 위해서는 serverType 을 SERVER_STUDIO4 로 명시해야합니다.
            };

            // mapData 가져오기
            mapData = await dabeeoMaps.getMapData(mapDataOption);

            // mapContainer
            const mapContainer = document.getElementById('map');

            // mapOption 정의
            const mapOption = {
                camera: '2d',
            };

            // mapOption으로 mapContainer에 map 그리기
            map = await dabeeoMaps.showMap(mapContainer, mapOption, mapData);

            initMenu(); // addBuilding, removeBuilding, changeFloor 를 하기 위한 selectBox option 생성 및 추가하는 코드

            //////////////////////////////// API 샘플 및 사용 예제 요약
            addBuildingTest(); // map.context.addBuilding() 테스트 코드
            removeBuildingTest(); // map.context.removeBuilding() 테스트 코드
            changeFloorTest(); // map.context.changeFloor() 테스트 코드
            routeSimulationTest(); // routeSimualtion 테스트 코드
            /////////////////////////////////////////////////////
        }

        init();

        function initMenu() {
            // mapData.dataBuilding 중 indoor 만 filter 하여 list 를 만듦
            const buildings = mapData.dataBuilding.getBuildings().filter((building) => building.buildingType === 'indoor');

            const addBuildingSelectBoxElement = document.querySelector("[name='addBuildingList']");
            const removeBuildingSelectBoxElement = document.querySelector("[name='removeBuildingList']");
            const floorSelectBoxElement = document.querySelector("[name='floorList']");

            // filter 한 building 을 조회하며 selectBox 의 option 생성 및 추가
            for (const building of buildings) {
                // addBuilding SelectBox option 생성 및 추가
                const addBuildingOption = document.createElement('option');
                addBuildingOption.value = building.id;
                addBuildingOption.appendChild(document.createTextNode(building.name[0].text));
                addBuildingSelectBoxElement.appendChild(addBuildingOption);

                // removeBuilding SelectBox option 생성 및 추가
                const removeBuildingOption = document.createElement('option');
                removeBuildingOption.value = building.id;
                removeBuildingOption.appendChild(document.createTextNode(building.name[0].text));
                removeBuildingSelectBoxElement.appendChild(removeBuildingOption);

                // building 안의 floor 를 조회하며 floorSelectBox option 생성 및 추가
                const floors = building.floors;
                for (const floor of floors) {
                    const floorOption = document.createElement('option');
                    floorOption.value = floor.id;
                    floorOption.appendChild(document.createTextNode(`${building.name[0].text} ${floor.name[0].text}`));
                    floorSelectBoxElement.appendChild(floorOption);
                }
            }

            // add building selectBox 의 첫번째 값을 selectedAddBuildingId 에 넣어줌 (초기값 설정)
            selectedAddBuildingId = addBuildingSelectBoxElement.options[0].value;

            // add building selectBox 에 change 이벤트를 추가, change 가 발생했을 때 선택된 값을 selectedAddBuildingId 에 넣어줌
            addBuildingSelectBoxElement.addEventListener('change', function (e) {
                selectedAddBuildingId = e.target.value;
            });

            // remove building selectBox 의 첫번째 값을 selectedRemoveBuildingId 에 넣어줌 (초기값 설정)
            selectedRemoveBuildingId = removeBuildingSelectBoxElement.options[0].value;

            // remove building selectBox 에 change 이벤트를 추가, change 가 발생했을 때 선택된 값을 selectedRemoveBuildingId 에 넣어줌
            removeBuildingSelectBoxElement.addEventListener('change', function (e) {
                selectedRemoveBuildingId = e.target.value;
            });

            // floor selectBox 의 첫번째 값을 selectedFloorId 에 넣어줌 (초기값 설정)
            selectedFloorId = floorSelectBoxElement.options[0].value;

            // floor selectBox 에 change 이벤트를 추가, change 가 발생했을 때 선택된 값을 selectedFloorId 에 넣어줌
            floorSelectBoxElement.addEventListener('change', function (e) {
                selectedFloorId = e.target.value;
            });
        }

        function addBuildingTest() {
            // button click event 추가, addBuilding() 함수 호출 시 await 를 붙여야 함, 선택된 빌딩 추가
            document.querySelector("[name='addBuilding']").addEventListener('click', async function () {
                await map.context.addBuilding(selectedAddBuildingId);
            });
        }

        function removeBuildingTest() {
            // button click event 추가, removeBuilding() 함수 호출, 선택된 building 제거
            document.querySelector("[name='removeBuilding']").addEventListener('click', function () {
                map.context.removeBuilding(selectedRemoveBuildingId);
            });
        }

        function changeFloorTest() {
            // button click event 추가, floorChange() 함수 호출시 await 를 붙여야 함, 선택된 floor 로 층변경
            // 현재 그려져있지 않은 building 의 층으로는 층변경 할 수 없음
            document.querySelector("[name='changeFloor']").addEventListener('click', async function () {
                await map.context.changeFloor(selectedFloorId);
            });
        }

        function routeSimulationTest() {
            // button click event 추가, 버튼 클릭 시 마포티타운 건물에서 실외지도를 거쳐 프론트원 건물로 가는 길찾기 경로 표출
            document.querySelector("[name='getRouteOn']").addEventListener('click', async function () {
                // option 에 따른 경로 검색
                const naivResponse = await mapData.getRoute({
                    // 마포티타운 건물 8층의 poi
                    origin: {
                        floorId: 'fb84a440-6f82-4ea2-982d-d1c79d3f730e',
                        poiId: 'f666436e-b345-4507-b8e2-18e3e69f9f2b',
                    },
                    // 프론트원 건물 1층의 poi
                    destination: {
                        floorId: 'b4a43600-69cb-4ea6-98b2-1779c60fe9c7',
                        poiId: 'c8577a6d-e5f2-4cf8-9a2c-e7b59c637857',
                    },
                    type: ['recommendation'],
                });
                const naviOption = {
                    origin: {
                        markerOptions: {
                            width: 30,
                            height: 30,
                            visibleIcon: true,
                        },
                    }, // 출발지 아이콘 및 주행선
                    destination: {
                        markerOptions: {
                            width: 50,
                            height: 50,
                            visibleIcon: true,
                        },
                        lineOptions: {
                            lineColor: '#ffbb00',
                            solidLineEnabled: true,
                            solidLineWidth: 20,
                        },
                    }, // 도착지 아이콘 및 주행선

                    defaultLineOption: {
                        lineColor: '#ffbb00',
                        solidLineEnabled: true,
                        solidLineWidth: 5,
                        solidLineCap: 'round',
                        solidLineJoin: 'round',
                    }, // 기본 주행선 옵션
                    lineDivide: false, // 네비게이션 선 분할여부 결정 (false 인 경우, defaultLineOption 만 사용)
                };
                // 구한 경로를 지도에 표출
                await map.routeSimulation.set(naivResponse.recommendation, naviOption);
            });

            // button click event 추가, 버튼 클릭 시 길찾기 시뮬레이션을 start
            document.querySelector("[name='start']").addEventListener('click', async function () {
                const animOption = {
                    twoFloorsNavigationDuration: 1000,
                    speedRate: 40,
                    removeIcon: false,
                    zoom: 20.4,
                    markerOptions: {
                        iconUrl: 'https://assets.dabeeomaps.com/image/ico/img_person-3x.png',
                        width: 30,
                        height: 30,
                        anchor: {
                            x: 0.5,
                            y: 0.5,
                        },
                    },
                    enableFloorMotionCSS: true,
                    changeFloorDelay: 500,
                };
                await map.routeSimulation.start(animOption);
            });

            // button click event 추가, 버튼 클릭 시 길찾기 시뮬레이션을 stop
            document.querySelector("[name='stop']").addEventListener('click', function () {
                map.routeSimulation.stop();
            });

            // button click event 추가, 버튼 클릭 시 길찾기 경로 제거
            document.querySelector("[name='clear']").addEventListener('click', function () {
                map.routeSimulation.clear();
            });
        }
    </script>
</html>
