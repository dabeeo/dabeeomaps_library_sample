<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>control camera sample</title>
        <!-- <link rel="stylesheet" href="style.css"> -->
        <style>
            .function {
                text-align: center;
            }

            .function:hover {
                background-color: gold;
            }
        </style>
    </head>
    <link rel="stylesheet" href="../styles/left.css">
    <body>
        <div class='container'>
            <button type="button" class="button-menu">floor</button>
            <select type="text" class="inline-input" name="floor"></select>
        </div>
        <div id="map" class="map"></div>
    </body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
    <script type="text/javascript" src="https://assets.dabeeomaps.com/upload/library/dabeeomaps-4.0-pre-release.js"></script>

    <script>
        const dabeeoMaps = new dabeeo.Maps();
        let mapData = null;
        let map = null;
        let mapContainer = null;

        const gui = new dat.GUI();

        const mapOptionDefault = {
            camera: '3d',
            controlOption: {
                zoom: 20, //초기줌
            },
        };
        async function init() {
            mapData = await dabeeoMaps.getMapData({
                clientId: '75hb8YSnAokb-sZ04aDR91',
                clientSecret: '0f7ad84f160c7b3fd1849a7920af718b',
            });

            mapContainer = document.getElementById('map');
            map = await dabeeoMaps.showMap(mapContainer, mapOptionDefault, mapData);

            initFloorMenu();
            initFloorEvent();
            initChangeCamera();
            initZoomIn();
            initZoomOut();
            initChangeZoom();
            initReset();
            initMoveTo();
            initSet();
            initEvent();
        }

        function initFloorMenu() {
            //floor data
            const dataFloor = mapData.dataFloor;
            const floorInfo = dataFloor.getFloors();
            const mapDefaultFloor = dataFloor.getDefaultFloor();
            let element = document.querySelector("[name='floor']");

            for (const floor of floorInfo) {
                let newOption = document.createElement('option');
                newOption.value = floor.id;
                newOption.appendChild(document.createTextNode(floor.name[0].text));
                element.appendChild(newOption);
            }
            element.value = mapDefaultFloor.id;
        }

        function initFloorEvent() {
            const optionDefaultFloor = map.context.getMapOptions().floor;
            let element = document.querySelector("[name='floor']");
            element.value = optionDefaultFloor;
            element.addEventListener('change', async function (e) {
                const floor = e.target.value;
                await map.context.changeFloor(floor);
            });
        }

        //Change Camera
        function initChangeCamera() {
            const changeCamera = (value) => {
                map.control.changeCamera(value);
            };
            const setting = { mode: mapOptionDefault.camera };
            gui.add(setting, 'mode', ['2d', '3d']).onChange(changeCamera);
        }

        //Zoom In
        function initZoomIn() {
            const zoomIn = (value) => {
                const zoomInOption = {
                    transition: settingZoomIn.transition,
                };
                console.log(zoomInOption);

                map.control.zoomIn(zoomInOption);
            };
            const settingZoomIn = {
                transition: false,
                zoomIn: zoomIn,
            };
            const zoomInMenu = gui.addFolder('Zoom In');
            zoomInMenu.open();
            zoomInMenu.add(settingZoomIn, 'transition');
            zoomInMenu.add(settingZoomIn, 'zoomIn');
        }

        //Zoom out
        function initZoomOut() {
            const zoomOut = (value) => {
                const zoomOutOption = {
                    transition: settingZoomOut.transition,
                };
                console.log(zoomOutOption);
                map.control.zoomOut(zoomOutOption);
            };
            const settingZoomOut = {
                transition: false,
                zoomOut: zoomOut,
            };

            const zoomOutMenu = gui.addFolder('Zoom Out');
            zoomOutMenu.add(settingZoomOut, 'transition');
            zoomOutMenu.add(settingZoomOut, 'zoomOut');
            zoomOutMenu.open();
        }

        const settingChangeZoom = {
            transition: false,
            zoom: mapOptionDefault.controlOption.zoom,
        };
        function initChangeZoom() {
            const changeZoom = (value) => {
                const changeZoomOption = {
                    transition: settingChangeZoom.transition,
                    zoom: value,
                };
                console.log(changeZoomOption);

                map.control.changeZoom(changeZoomOption);
            };
            const changeZoomMenu = gui.addFolder('Change Zoom');
            changeZoomMenu.add(settingChangeZoom, 'transition');
            changeZoomMenu.add(settingChangeZoom, 'zoom').onFinishChange(changeZoom);
            changeZoomMenu.open();
        }

        //reset
        function initReset() {
            const reset = (value) => {
                const resetOption = {
                    transition: settingReset.transition,
                };
                console.log(resetOption);
                map.control.reset(resetOption);
            };
            const settingReset = {
                transition: false,
                reset: reset,
            };
            const resetMenu = gui.addFolder('Reset');
            resetMenu.open();
            resetMenu.add(settingReset, 'transition');
            resetMenu.add(settingReset, 'reset');
        }

        //initMoveTo
        function initMoveTo() {
            const moveTo = (value) => {
                const moveToOption = {
                    position: { x: settingMoveTo.x, y: settingMoveTo.y },
                    transition: settingMoveTo.transition,
                };
                console.log(moveToOption);
                map.control.moveTo(moveToOption);
            };
            const settingMoveTo = {
                transition: false,
                x: 1000,
                y: 1000,
                moveTo: moveTo,
            };
            const moveToMenu = gui.addFolder('Move To');
            moveToMenu.open();
            moveToMenu.add(settingMoveTo, 'transition');
            moveToMenu.add(settingMoveTo, 'x');
            moveToMenu.add(settingMoveTo, 'y');
            moveToMenu.add(settingMoveTo, 'moveTo');
        }

        //initSet
        const set = (value) => {
            const setOption = {
                rotation: settingSet.rotation,
                tilt: settingSet.tilt,
                zoom: settingSet.zoom,
                transition: settingSet.transition,
            };
            console.log(setOption);
            map.control.set(setOption);
        };

        const settingSet = {
            rotation: 0,
            tilt: 0,
            zoom: mapOptionDefault.controlOption.zoom,
            set: set,
            transition: false,
        };

        function initSet() {
            const setMenu = gui.addFolder('Set');
            setMenu.open();
            setMenu.add(settingSet, 'transition');
            setMenu.add(settingSet, 'rotation');
            setMenu.add(settingSet, 'tilt');
            setMenu.add(settingSet, 'zoom');
            setMenu.add(settingSet, 'set');
        }

        //event
        function initEvent() {
            mapContainer.addEventListener('zoom-changed', (e) => {
                console.log('zoom-changed 에 대한 결과값', e.detail);
                settingChangeZoom.zoom = e.detail.changedValue;
                settingSet.zoom = e.detail.changedValue;
            });
            // camera tilt changed
            mapContainer.addEventListener('tilt-changed', (e) => {
                console.log('tilt-changed 에 대한 결과값', e.detail);
                settingSet.tilt = e.detail.changedValue;
            });
            // camera rotation changed
            mapContainer.addEventListener('rotation-changed', (e) => {
                console.log('rotation-changed 에 대한 결과값', e.detail);
                settingSet.rotation = e.detail.changedValue;
            });

            // camera rotation changed
            mapContainer.addEventListener('control-start', (e) => {
                console.log('control start 에 대한 결과값', e.detail);
            });

            // camera rotation changed
            mapContainer.addEventListener('control-end', (e) => {
                console.log('control end 에 대한 결과값', e.detail);
            });
        }
        init();
    </script>
</html>
