<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="../dabeeo_ci_symbol.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dabeeo smc</title>
    <style>
        body {
            overflow: hidden;
            /* Hide scrollbars */
        }

        .map {
            width: 100vw;
            height: 100vh;
        }

        .clicked {
            background-color:grey;
        }
    </style>
</head>

<body>

    <button type="button" class="button-menu">building</button>
    <select type="text" class="inline-input" name="building">
        <option value="">전체</option>
    </select>
    <span id="floor"></span>
    <span id="layer3"></span>

    <!-- <div id='map' class="map"></div> -->
</body>
<!-- <script type="text/javascript" src='https://assets.dabeeomaps.com/upload/library/dabeeomaps-4.1.0.js'></script> -->
<script type="text/javascript" src='https://assets.dabeeomaps.com/upload/library/dabeeomaps-4.0-pre-release.js'></script>

<script>
    const dabeeoMaps = new dabeeo.Maps();
    // indoor map data, map context
    let mapDataIndoor = null;
    let mapIndoor = null;

    // outdoor map data, map context
    let mapDataOutdoor = null;
    let mapOutdoor = null;

    //initialize mapIndoor load flag
    let mapIndoorloaded = false;

    async function init () {
        // const dabeeoMaps = new dabeeo.Maps();

        //// fetch a indoor map data
        mapDataIndoor = await dabeeoMaps.getMapData({
            clientId: "cmnGuxYqQkV87wHcXXOvfN",
            clientSecret: "46a9752504f3054998b53adbfb73297e",
        });

        //// fetch a outdoor map data 
        mapDataOutDoor = await dabeeoMaps.getMapData({
            clientId: "47o545DKANS8Jra5FZUXJq",
            clientSecret: "72671b30f940fc0bcb7225fe2e0b27b7",
        });

        //// render a outdoor map
        const mapContainer = document.createElement("div");
        mapContainer.classList.add("map");
        document.body.appendChild(mapContainer);

        const mapOption = Object.assign({
            // set camera to 2d or 3d mode 
            camera: "3d",
            controlOption: {
                rotate: 180,
                tilt: 60,
            }
        });
        mapOutdoor = await dabeeoMaps.showMap(mapContainer, mapOption, mapDataOutDoor);

        // disable rotation
        mapOutdoor.control.setOption({
            mouseOption: {
                enableRotate: false,
                enableTilt: false,
                enablePan: false,
            },
        })

        //building mapData, outdoor map context
        initLayer1();
    }

    // make up building select menu 
    function initLayer1 () {

        //group contains the structure of smc 
        //building(layer1), 
        //floor(layer2), 
        //zone(layer3-"xx_Depth3"-layer4 ), 
        //detail info(layer3-"xx_Depth4")

        //root group is the same as building of the outdoor map
        //get the root group from data group
        const layer1 = mapDataIndoor.dataGroupCode.findRoot();

        let element = document.querySelector("[name='building']");
        layer1.forEach(code => {

            // debug code
            // const layer2 = mapDataIndoor.dataGroupCode.findChild(code);
            // layer2.forEach(code => {
            //     console.log(mapDataIndoor.dataGroupCode.findChild(code))
            // });

            let newOption = document.createElement("option");
            newOption.value = code
            newOption.appendChild(document.createTextNode(code));
            element.appendChild(newOption);
        });


        //select building -> init floor
        element.addEventListener("change", function (e) {
            const layer1 = e.target.value;
            initLayer2(layer1)
        });
    }

    function initMenu () {
        let elementFloor = document.querySelector("#floor");
        elementFloor.innerHTML = '';
        let elementLayer3 = document.querySelector("#layer3");
        elementLayer3.innerHTML = '';
    }
    function makeSelectElement () {
        let element = document.querySelector("#floor");

        let newButton = document.createElement("button");
        newButton.type = "button";
        newButton.innerHTML = 'floor';
        element.appendChild(newButton);

        let newSelect = document.createElement("select");
        newSelect.innerHTML = '<option value="">전체</option>';
        element.appendChild(newSelect);
        return newSelect;

    }

    //makeup floor select menu
    function initLayer2 (layer1) {

        initMenu();

        //layer2 is floors of selected layer1(building)
        const layer2 = mapDataIndoor.dataGroupCode.findChild(layer1);
        // console.log(layer2);
        const element = makeSelectElement();
        if (!layer2) return;

        layer2.forEach(code => {
            let newOption = document.createElement("option");
            floors = mapDataIndoor.dataFloor.find(code, { type: 'title' });
            if (floors.legnth > 1) console.log('ERROR');

            newOption.value = floors[0].id;
            newOption.appendChild(document.createTextNode(code));
            element.appendChild(newOption);
        });

        //select floor -> init zone
        element.addEventListener("change", async function (e) {
            const layer2 = e.target.options[e.target.selectedIndex].text;
            const floorId = e.target.value;

            if (!mapIndoorloaded) {
                mapIndoorloaded = true;
                //clean up memory of outdoor map and container 
                mapOutdoor.context.cleanup();
                document.querySelector('.map').remove();

                //// render a indoor map
                const mapContainer = document.createElement("div");
                mapContainer.classList.add("map");
                document.body.appendChild(mapContainer);

                const mapOption = Object.assign({
                    // set camera to 2d mode 
                    camera: "2d",
                    floor: floorId
                });
                mapIndoor = await dabeeoMaps.showMap(mapContainer, mapOption, mapDataIndoor);
                mapIndoor.control.setOption({
                    mouseOption: {
                        enableRotate: false,
                        enableTilt: false,
                        // enablePan: false,
                    },
                })
            } else {
                console.log('changeFloor');
                await mapIndoor.context.changeFloor(floorId);
            }

            initLayer3(layer2)
        });
    }

    function initLayer3 (layer2) {

        const layer3 = mapDataIndoor.dataGroupCode.findChild(layer2);

        let element = document.querySelector("#layer3");
        element.innerHTML = '';

        layer3.forEach(code => {
            let newButton = document.createElement("button");
            newButton.type = "button";
            newButton.innerHTML = code;
            newButton.className = "button"
            element.appendChild(newButton);
            let ishidden = true;
            mapIndoor.context.hideByCode(code);

            newButton.addEventListener('click', function (e) {
                const code = e.target.innerHTML;
                e.target.classList.toggle('clicked');
                if (ishidden) {
                    mapIndoor.context.showByCode(code);
                    ishidden = false;
                } else {
                    mapIndoor.context.hideByCode(code);
                    ishidden = true;
                }
            });
        });

    }
    init();
</script>

</html>