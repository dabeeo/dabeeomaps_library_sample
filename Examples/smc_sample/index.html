<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="../dabeeo_ci_symbol.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>map context sample</title>
    <style>
        .map {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>

<body>

    <button type="button" class="button-menu">building</button>
    <select type="text" class="inline-input" name="building">
        <option value="">전체</option>
    </select>

    <button type="button" class="button-menu">floor</button>
    <select type="text" class="inline-input" name="floor">
        <option value="">전체</option>
    </select>

    <button type="button" class="button-menu">zone</button>
    <select type="text" class="inline-input" name="zone">
        <option value="">전체</option>
    </select>

    <button type="button" class="inline-input" name="detail">상세위치</button>
    <button type="button" class="inline-input" name="firesafe">화재안전</button>
    <button type="button" class="inline-input" name="toxic">유해물질</button>

    <!-- <div id='map' class="map"></div> -->
</body>
<!-- <script type="text/javascript" src='https://assets.dabeeomaps.com/upload/library/dabeeomaps-4.1.0.js'></script> -->
<script type="text/javascript" src='https://assets.dabeeomaps.com/upload/library/dabeeomaps-4.0-pre-release.js'></script>

<script>
    const dabeeoMaps = new dabeeo.Maps();
    let mapData = null;
    let map = null;
    let mapDataOutdoor = null;
    let mapOutdoor = null;


    async function init () {
        // const dabeeoMaps = new dabeeo.Maps();

        //// fetch a buidling map data
        mapData = await dabeeoMaps.getMapData({
            clientId: ,
            clientSecret: ,
        });

        //// fetch a outdoor map data 
        mapDataOutDoor = await dabeeoMaps.getMapData({
            clientId: ,
            clientSecret: ,
        });


        //// render a outdoor map
        const mapContainer = document.createElement("div");
        mapContainer.classList.add("map");
        document.body.appendChild(mapContainer);

        const mapOption = Object.assign({
            // set camera to 2d mode 
            camera: "3d",
            controlOption: {
                rotate: 180,
                tilt: 60,
            }
        });
        mapOutdoor = await dabeeoMaps.showMap(mapContainer, mapOption, mapDataOutDoor);

        // disable rotation
        mapOutdoor.control.setOption({
            mouseOption: {
                enableRotate: false,
                enableTilt: false,
                enablePan: false,
            },
        })

        //building mapData, outdoor map context
        initBuilding();
    }

    // make up building select menu 
    let maploaded = false;
    function initBuilding () {
        const buildings = mapData.dataGroupCode.findRoot();

        let element = document.querySelector("[name='building']");

        for (const building of buildings) {
            let newOption = document.createElement("option");
            newOption.value = building
            newOption.appendChild(document.createTextNode(building));
            element.appendChild(newOption);
        }
        //select building -> init floor
        element.addEventListener("change", function (e) {
            const building = e.target.value;
            initFloors(building)
        });
    }

    //makeup floor select menu
    function initFloors (building) {
        const floors = mapData.dataFloor.find(building + '_', { type: 'title' });

        let element = document.querySelector("[name='floor']");
        element.innerHTML = '<option value="">전체</option>';

        for (const floor of floors) {
            let newOption = document.createElement("option");
            newOption.value = floor.id;
            newOption.appendChild(document.createTextNode(floor.name[0].text));
            element.appendChild(newOption);
        }

        //select floor -> init zone
        element.addEventListener("change", async function (e) {
            const floorId = e.target.value;

            if (!maploaded) {
                maploaded = true;
                //clean up memory of outdoor map and container 
                mapOutdoor.context.cleanup();
                document.querySelector('.map').remove();

                //// render a indoor map
                const mapContainer = document.createElement("div");
                mapContainer.classList.add("map");
                document.body.appendChild(mapContainer);

                const mapOption = Object.assign({
                    // set camera to 2d mode 
                    camera: "2d",
                    floor: floorId
                });
                map = await dabeeoMaps.showMap(mapContainer, mapOption, mapData);
                map.control.setOption({
                    mouseOption: {
                        enableRotate: false,
                        enableTilt: false,
                        // enablePan: false,
                    },
                })
            } else {
                await map.context.changeFloor(floorId);
            }
            const floorObj = mapData.dataFloor.find(floorId, { type: 'id' })
            const floorName = floorObj.name[0].text;
            map.context.hideByCode(floorName);

            initZone(floorName);
            initFireToxic(floorName);
            initDetail(floorName);

        });
    }
    function hideDepth3 (depth2, depth3) {
        if (mapData.dataGroupCode.findChild(depth2).includes(depth3)) {
            map.context.hideByCode(depth3);
        }
    }
    function showDepth3 (depth2, depth3) {
        if (mapData.dataGroupCode.findChild(depth2).includes(depth3)) {
            map.context.showByCode(depth3);
        }
    }

    //init detail button 
    function initDetail (depth2) {
        const depth4 = depth2 + '_Depth4';
        const depth3 = depth2 + '_Depth3';
        let detailOn = true;
        document.querySelector("[name='detail']").addEventListener('click', function () {
            if (detailOn) {
                hideDepth3(depth2, depth3);
                map.context.showByCode(depth4);
                detailOn = false;
            } else {
                showDepth3(depth2, depth3);
                map.context.hideByCode(depth4);
                detailOn = true;
            }
        });
    }

    //make up the zone select menu
    function initZone (depth2) {
        map.context.hideByCode(depth2);
        const depth3 = depth2 + '_Depth3';
        const depth4 = depth2 + '_Depth4';

        if (mapData.dataGroupCode.findChild(depth2).includes(depth3)) {
            map.context.showByCode(depth3);
            const codeList = mapData.dataGroupCode.findChild(depth3);

            const element = document.querySelector("[name='zone']");
            element.innerHTML = '<option value="">전체</option>';

            for (const code of codeList) {
                let newOption = document.createElement("option");
                newOption.value = code;
                newOption.appendChild(document.createTextNode(code));
                element.appendChild(newOption);
            }

            //select zone -> focus to zone
            element.addEventListener("change", function (e) {
                const zone = e.target.value;
                map.context.hideByCode(depth3);
                map.context.hideByCode(depth4);

                focusToZone(zone);
            });
        }
    }

    // focus to zone
    function focusToZone (zone) {
        map.context.showByCode(zone);
        const objects = mapData.dataObject.find(zone, { type: "groupCode" });
        const pois = mapData.dataPoi.find(zone, { type: "groupCode" });
        const objectIds = objects.map((object) => { return object.id; });
        console.log(objectIds);

        map.control.focusTo({
            focus: {
                ids: objectIds,
                type: 'object',
            },
            transition: true,
            padding: {
                top: 20,
                left: 20,
                bottom: 20,
                right: 20
            }
        });
        map.control.set({
            zoom: 200
        });
    }

    // init firesafe and toxic button
    function initFireToxic (depth2) {
        const firesafe = depth2 + '_화재안전';
        const toxic = depth2 + '_유해물질';

        let firesafeOn = true;
        document.querySelector("[name='firesafe']").addEventListener('click', function () {
            if (firesafeOn) {
                map.context.showByCode(firesafe);
                firesafeOn = false;
            } else {
                map.context.hideByCode(firesafe);
                firesafeOn = true;
            }
        });

        let toxicOn = true;
        document.querySelector("[name='toxic']").addEventListener('click', function () {
            if (toxicOn) {
                map.context.showByCode(toxic);
                toxicOn = false;
            } else {
                map.context.hideByCode(toxic);
                toxicOn = true;
            }
        });
    }

    init();
</script>

</html>