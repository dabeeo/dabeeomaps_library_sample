<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>dabeeo indoor tracking</title>
        <style>
            body {
                margin: 0;
            }
            #map {
                width: 100vw;
                height: 100vh;
                /* border: 1px solid black; */
            }
            #tracking-info {
                display: flex;
                flex-direction: column;
                gap: 0.3rem;
                position: absolute;
                left: 0;
                bottom: 0;
                margin: 1rem;
                padding: 1rem;
                width: 90%;
                height: fit-content;
                z-index: 999;
                background-color: rgba(255, 255, 255, 0.5);
            }

            .stats {
                font-size: 0.8rem;
                font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue',
                    sans-serif;
            }

            .stats span {
                color: red;
            }
        </style>
    </head>

    <body>
        <div id="container">
            <div class="stats">내 위치 상태: <span id="myloc-state"></span></div>
            <button id="routeSimulationSet">모의주행 시작</button>
            <button id="routeSimulationClear">모의주행 종료</button>
            <button id="mylocationSet">내위치 마커 켜기</button>
            <button id="indoorStart">indooor tracking 시작</button>
            <button id="navigationOn">navigation 모드 시작</button>
            <button id="navigationOff">navigation 모드 종료</button>
            <button id="indoorStop">indooor tracking 종료</button>
            <button id="mylocationClear">내위치 마커 끄기</button>
            <button id="heading">Heading On/Off</button>
            <button id="focus">Focus On/Off</button>
        </div>
        <div id="map" class="map"></div>
        <div id="tracking-info">
            <div class="stats">현상태: <span id="current_state"></span></div>
            <div class="stats">현위치: <span id="current_position"></span></div>
            <div class="stats">가장 가까운 지점: <span id="closestPoint"></span></div>
            <div class="stats">출발지거리: <span id="distance_from_origin"></span></div>
            <div class="stats">도착지거리: <span id="distance_to_destination"></span></div>
            <div class="stats">현재 path: <span id="current_path"></span></div>
            <div class="stats">현재 path각도: <span id="current_angle"></span></div>
            <div class="stats">path와 거리: <span id="distance_to_closest_path"></span></div>
            <div class="stats">다음 방향: <span id="next_step"></span></div>
        </div>
    </body>
    <!-- <script type="text/javascript" src="../../build/dabeeomaps-4.0.0.js"></script> -->
    <script type="text/javascript" src="https://api-assets.dabeeomaps.com/upload/library/dabeeomaps-4.0-pre-release.js"></script>

    <script type="module">
        let mapData = null;
        let map = null;
        let heading = true;
        let focus = true;

        async function init() {
            // 지도 api 불러오기
            const dabeeoMaps = new dabeeo.Maps();
            // 지도 데이터 가져오기
            mapData = await dabeeoMaps.getMapData({
                // 공덕역 사무실
                clientId: '6FLO-0RJQDv9oPd_mgAJX0',
                clientSecret: '4ff90a5feffb4d5d785994e981cf3924',
            });
            const mapContainer = document.getElementById('map');

            // 지도 그리기
            const mapOption = Object.assign({
                camera: '2d',
            });
            map = await dabeeoMaps.showMap(mapContainer, mapOption, mapData);

            ///////////////////////////////// API 샘플 및 사용 예제 요약
            initRouteSimulation(); // 모의주행 시작
            clearRouteSimulation(); // 모의주행 종료
            initMyLocationSet(); // 내위치 마커 켜기
            indoorStartTest(); // indoor tracking 시작
            indoorTrackingOnTest(); // 네비게이션 모드 시작
            indoorTrackingOffTest(); // 네비게이션 모드 종료
            indoorStopTest(); // indoor tracking 종료
            initMyLocationClear(); // 내위치 마커 끄기
            initIndoorHeadingOnOff(); // Heading on/off
            initIndoorFocusOnOff(); // Focus on/off
            trackingCompleteEventTest(); // tracking-complete 이벤트 및 map.mylocation.indoorStop() 테스트
            trackingMoveEventTest(); // tracking-move 이벤트 테스트
            mylocationMapOutEventTest(); // mylocation-map-out 이벤트 테스트
            mylocationMapInTest(); // mylocation-map-in 이벤트 테스트

            ///////////////////////////////////////
            // 모의주행 시작
            function initRouteSimulation() {
                const element = document.getElementById('routeSimulationSet');
                element.addEventListener('click', async () => {
                    // 경로 찾기
                    const routeOption = {
                        origin: { position: { x: 1745, y: 1470 }, floorId: 'FL-vevccrt2oto33702' },
                        destination: { position: { x: 4236, y: 2146 }, floorId: 'FL-vevccrt2oto33702' },
                    };
                    const naviResponse = await mapData.getRoute(routeOption); // 모의주행 경로 찾기
                    const naviOption = {
                        lineDivide: false, // 네비게이션 선 분할여부 결정 (false 인 경우, defaultLineOption 만 사용)
                        defaultLineOption: {
                            // 기본 주행선 옵션
                            lineColor: '#0000ff', // navigation 주행 라인의 색상을 지정
                            lineSpotSize: 10, // 주행선의 점의 굵기를 지정합니다. 주행선의 속성이 점선일 경우 적용됩니다.
                            solidLineEnabled: true, // 주행라인의 속성을 결정합니다. false일 때는 점선, true일 때는 실선으로 그려집니다. default는 false.
                            solidLineWidth: 30, // 실선의 굵기입니다. default는 1
                        },
                        destination: {
                            // 도착지 마커 및 주행선 옵션
                            showTag: false, // 도착지 말풍선 생성 여부 (기본값 true)
                        },
                    };

                    await map.routeSimulation.set(naviResponse?.recommendation, naviOption); // 모의주행 선 그리기
                    const animOption = {
                        speedRate: 100,
                    };

                    await map.routeSimulation.start(animOption); // 모의주행 애니메이션 시작
                });
            }

            // 모의주행 종료
            function clearRouteSimulation() {
                const element = document.getElementById('routeSimulationClear');
                element.addEventListener('click', async () => {
                    await map.routeSimulation.stop(); // 모의주행 종료
                    await map.routeSimulation.clear(); // 모의주행 선 삭제
                });
            }

            // 내위치 마커 표출
            function initMyLocationSet() {
                const element = document.getElementById('mylocationSet');
                element.addEventListener('click', () => {
                    const locationOption = {
                        x: 1745,
                        y: 1470,
                        iconOption: {
                            iconUrl: 'https://assets.dabeeomaps.com/image/ico/indoorlocation.png',
                            width: 60,
                            height: 60,
                        },
                        animate: {
                            color: '#0000ff',
                            opacity: 0.2,
                            desireScale: 2,
                            duration: 1500,
                        },
                        gpsOption: {
                            leftCourseDistance: 5, // 경로이탈 여부 (ON_PATH 와 OUT_OF_PATH) 를 판단하는 기준 거리
                            willArriveRadius: 10, // 도착 예정 범위 반경
                            arrivedRadius: 5, // 도착 범위 반경
                        },
                    };
                    map.mylocation.set(locationOption); // myLocation 생성
                    map.control.moveTo({ position: { x: 1745, y: 1470 }, transition: true }); // 지정한좌표를 화면 중앙으로
                });
            }

            //indoor tracking service 시작
            function indoorStartTest() {
                const button = document.getElementById('indoorStart');
                button.addEventListener('click', (e) => {
                    alert('Indoor Tracking 서비스를 시작합니다');
                    const indoorTrackingOption = {
                        orient: 0,
                        position: { x: 1745, y: 1470 }, // My location coordinates
                        height: 170,
                        focus: true,
                        heading: true,
                    };

                    map.mylocation.indoorStart(indoorTrackingOption); // geolocation 시작
                });
            }

            // 네비게이션 모드 시작
            function indoorTrackingOnTest() {
                const button = document.getElementById('navigationOn');
                button.addEventListener('click', async (e) => {
                    alert('Navigation 서비스를 시작합니다');
                    const routeOption = {
                        origin: { position: { x: 1745, y: 1470 }, floorId: 'FL-vevccrt2oto33702' },
                        destination: { position: { x: 4236, y: 2146 }, floorId: 'FL-vevccrt2oto33702' },
                    };
                    const naviResponse = await mapData.getRoute(routeOption); // 모의주행 경로 찾기
                    const naviOption = {
                        lineDivide: false, // 네비게이션 선 분할여부 결정 (false 인 경우, defaultLineOption 만 사용)
                        defaultLineOption: {
                            // 기본 주행선 옵션
                            lineColor: '#0000ff', // navigation 주행 라인의 색상을 지정
                            lineSpotSize: 10, // 주행선의 점의 굵기를 지정합니다. 주행선의 속성이 점선일 경우 적용됩니다.
                            solidLineEnabled: true, // 주행라인의 속성을 결정합니다. false일 때는 점선, true일 때는 실선으로 그려집니다. default는 false.
                            solidLineWidth: 30, // 실선의 굵기입니다. default는 1
                        },
                        destination: {
                            // 도착지 마커 및 주행선 옵션
                            showTag: false, // 도착지 말풍선 생성 여부 (기본값 true)
                        },
                    };

                    await map.routeSimulation.set(naviResponse?.recommendation, naviOption); // 모의주행 선 그리기

                    map.routeSimulation.set(naviResponse?.recommendation);
                    map.mylocation.trackingOn(naviResponse?.recommendation); // tracking-move, tracking-complete 이벤트 활성화
                });
            }

            // 네비게이션 모드 중단 : tracking-move, tracking-complete 이벤트 비활성화
            function indoorTrackingOffTest() {
                const element = document.getElementById('navigationOn');
                element.addEventListener('click', () => {
                    alert('Navigation 서비스를 종료합니다');
                    map.mylocation.trackingOff();
                });
            }
            // indoor tracking service 종료
            function indoorStopTest() {
                const element = document.getElementById('indoorStop');
                element.addEventListener('click', () => {
                    alert('Indoor Tracking 서비스를 종료합니다');
                    map.mylocation.indoorStop(); // indoor tracking service 종료
                });
            }

            // myLocation 제거
            function initMyLocationClear() {
                const element = document.getElementById('mylocationClear');
                element.addEventListener('click', () => {
                    map.mylocation.clear();
                });
            }

            // indoor tracking service Heading 설정
            function initIndoorHeadingOnOff() {
                const element = document.getElementById('heading');
                element.addEventListener('click', () => {
                    alert(`Heading option을 ${!heading}으로 설정합니다`);
                    heading = !heading;
                    map.mylocation.indoorSetHeading(heading); // 신장 설정
                });
            }

            // indoor tracking service focus 설정
            function initIndoorFocusOnOff() {
                const element = document.getElementById('focus');
                element.addEventListener('click', () => {
                    alert(`Focus option을 ${!focus}으로 설정합니다`);
                    focus = !focus;
                    map.mylocation.indoorSetFocus(focus); // 신장 설정
                });
            }

            function trackingCompleteEventTest() {
                // tracking-complete
                mapContainer.addEventListener('tracking-complete', async (e) => {
                    console.log('tracking-complete에 대한 결과값: ', e.detail);
                    // map.mylocation.stop(); // geolocation 중단
                    alert('목적지에 도착하여 서비스를 종료합니다. ');
                    await map.mylocation.trackingOff();
                    map.mylocation.indoorStop(); // geolocation 시작
                });
            }

            function trackingMoveEventTest() {
                // tracking-move
                mapContainer.addEventListener('tracking-move', (e) => {
                    console.log('tracking-move에 대한 결과값: ', e.detail);
                    updateStats(e);
                });
            }

            // 마커가 지도 영역을 벗어났을 떄
            function mylocationMapOutEventTest() {
                // mylocation-map-out
                mapContainer?.addEventListener('mylocation-map-out', (e) => {
                    console.log('mylocation-map-out에 대한 결과값: ', e.detail);
                    alert('내위치가 지도 영역에서 벗어났습니다');
                    const mylocationState = document.getElementById('myloc-state');
                    mylocationState.textContent = e.detail;
                    map.mylocation.hide(); // 지도영역을 벗어나면 내 위치 마커를 감춤.
                });
            }

            // 마커가 지도영역안으로 들어왔을 때
            function mylocationMapInTest() {
                // mylocation-map-in
                mapContainer.addEventListener('mylocation-map-in', (e) => {
                    console.log('mylocation-map-in에 대한 결과값: ', e.detail);
                    alert('내위치가 지도 영역안으로 들어왔습니다');
                    const mylocationState = document.getElementById('myloc-state');
                    mylocationState.textContent = e.detail;
                    map.mylocation.show(); // 지도영역으로 돌아오면 내 위치 마커를 보여줌.
                });
            }

            function updateStats(e) {
                const trackingInfo = e.detail;
                for (const key in trackingInfo) {
                    const stat = document.getElementById(key);
                    if (stat) {
                        let content = trackingInfo[key];
                        if (Array.isArray(content)) {
                            content = `
               시작점 {
                 x: ${content[0].position.x.toFixed()},
                 y: ${content[0].position.y.toFixed()},
               } ~
               끝점 {
                 x: ${content[1].position.x.toFixed()},
                 y: ${content[1].position.y.toFixed()},
               }
             `;
                        }
                        if (key === 'closestPoint' || key === 'current_position') {
                            if (content instanceof Object) {
                                content = `
                 x: ${content.x.toFixed()},
                 y: ${content.y.toFixed()},
               `;
                            }
                        }
                        if (typeof content === 'number') {
                            content = content.toFixed();
                        }
                        stat.textContent = content;
                    }
                }
            }
        }
        init();
    </script>
</html>
