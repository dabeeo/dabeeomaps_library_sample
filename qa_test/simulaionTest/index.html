<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation test</title>
    <style>
        /* .map{
            width: 1000px;
            height: 700px;
            border: 1px solid black;
        } */
        .map {
            width: calc(100vw-10px);
            height: calc(100vh - 100px);
            border: 1px solid black;
        }

        .function {
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="map" class="map"></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>

<!-- <script type="text/javascript" src='../../build/dabeeomaps-4.0.0.js'></script> -->
<!-- <script type="text/javascript" src='https://assets.dabeeomaps.com/upload/library/dabeeomaps-4.1.0.js'></script> -->
<script type="text/javascript" src='https://assets.dabeeomaps.com/upload/library/dabeeomaps-4.0-pre-release.js'></script>

<script type="module">
    import { maps } from "../mapList.js";
    import { MapInfo } from '../MapInfo.js';
    import { MapOption } from '../MapOption.js';
    import { ContextMenu } from '../ContextMenu.js';
    import { SimulationMenu } from '../SimulationMenu.js';

    const gui = new dat.GUI({ width: 300 });
    const dabeeoMaps = new dabeeo.Maps();

    // menu initialization
    function init () {
        const mapContainer = document.querySelector('.map');
        const mapGui = gui.addFolder("mapMenu");

        let mapData = null;
        let map = null;
        let mapOption = null;
        let mapInfoMenu = null;
        let mapOptionMenu = null;
        let contextMenu = null;
        let simulationMenu = null;

        const deleteMapInfoMenu = () => {
            if (mapInfoMenu) {
                mapGui.removeFolder(mapInfoMenu);
                mapInfoMenu = null;
            }
        }

        const deleteMapOptionMenu = () => {
            if (mapOptionMenu) {
                mapGui.removeFolder(mapOptionMenu);
                mapOptionMenu = null;
            }
        }
        const deleteContextMenu = () => {
            if (contextMenu) {
                gui.removeFolder(contextMenu);
                contextMenu = null;
            }
        }

        const deleteSimulationMenu = () => {
            if (simulationMenu) {
                gui.removeFolder(simulationMenu);
                simulationMenu = null;
            }
        }

        const getMapData = async (value) => {

            if (setting.mapIndex < 0) {
                alert("map을 선택하세요. ");
                return;
            }
            const option = {
                clientId: maps[setting.mapIndex].clientId,
                clientSecret: maps[setting.mapIndex].clientSecret,
                serverType: "SERVER_REAL",
            };
            //mapData 가져오기
            deleteMap();
            deleteMapInfoMenu();
            deleteMapOptionMenu();
            deleteContextMenu();
            deleteSimulationMenu();
            mapData = await dabeeoMaps.getMapData(option);
            mapInfoMenu = new MapInfo(mapGui, mapData).init();
            mapOption = new MapOption(mapGui, mapData);
            mapOptionMenu = mapOption.init();
        }
        const showMap = async (value) => {
            if (!mapData) {
                alert("mapData is not available");
                return;
            }
            const option = mapOption.getOption();
            deleteMap();
            deleteContextMenu();
            deleteSimulationMenu();
            map = await dabeeoMaps.showMap(mapContainer, option, mapData);
            contextMenu = new ContextMenu(gui, mapData, map).init();
            simulationMenu = new SimulationMenu(gui, mapData, map).init();
        }

        const deleteMap = () => {
            if (map) {
                map.context.cleanup();
                map = null;
            }
        };

        const setting = {
            mapIndex: -1,
            getMapData: getMapData,
            showMap: showMap,
            deleteMap: deleteMap
        };
        const mapSetting = {
            선택: -1,
            사무실: 0,
            이케아: 1,
            삼성서울병원전경: 2,
            삼성서울병원실내: 3,
        }
        mapGui.add(setting, "mapIndex", mapSetting).onChange(getMapData);
        mapGui.add(setting, "showMap");
        mapGui.add(setting, "deleteMap");

    }

    init(); 
</script>

</html>